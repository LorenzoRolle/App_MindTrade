<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trade Input - MindTrade</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f6f8fa; margin: 0; padding: 20px; }
    .container { max-width: 750px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 0 12px rgba(0,0,0,0.05); }
    h2 { text-align: center; margin-bottom: 25px; }
    h3 { margin-top: 30px; font-size: 18px; border-bottom: 1px solid #ddd; padding-bottom: 5px; color: #333; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
    textarea { resize: vertical; min-height: 80px; }
    button { margin-top: 20px; padding: 12px; width: 100%; background-color: #007bff; color: white; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    .user-info { text-align: right; margin-bottom: 20px; color: #666; }
    .user-info a { color: #007bff; text-decoration: none; }
    .user-info a:hover { text-decoration: underline; }
    .pnl-preview { margin-top: 10px; padding: 8px; border-radius: 5px; font-weight: bold; text-align: center; }
    .profit { background-color: #d4edda; color: #155724; }
    .loss { background-color: #f8d7da; color: #721c24; }
    .hint { font-size: 12px; color: #666; font-style: italic; margin-top: 5px; }
    .upload-zone { border: 2px dashed #888; border-radius: 10px; padding: 20px; text-align: center; color: #aaa; font-size: 16px; transition: border-color 0.3s; cursor: pointer; margin-bottom: 15px; }
    .upload-zone.dragover { border-color: #4cafef; color: #4cafef; }
    @media (max-width: 600px) { .container { padding: 20px; } input, textarea, select { font-size: 16px; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="user-info">
      {% if session.user %}
        <a href="/home">üè† Home</a> |
        Welcome, {{ session.user }}! | <a href="/view_notifications">View Trades</a> | <a href="/results">üß† My Analysis</a> | <a href="/logout">Logout</a>
      {% endif %}
    </div>

    <h2>üß† Insert Trade for Analysis</h2>

    <!-- JSON Upload -->
    <div id="uploadZone" class="upload-zone">
      Drag & Drop JSON File Here or Click to Select
    </div>
    <input type="file" id="fileInput" accept=".json" style="display:none;">

    <form method="POST" action="/trade_input" id="tradeForm">
      <h3>üìä Trade Details</h3>

      <label>Asset Name *</label>
      <input type="text" name="asset_name" placeholder="e.g., AAPL, Bitcoin, EUR/USD" required>
      
      <label>Asset Type</label>
      <select name="asset_type">
        <option value="">-- Select --</option>
        <option value="stock">Stock</option>
        <option value="etf">ETF</option>
        <option value="crypto">Crypto</option>
        <option value="forex">Forex</option>
      </select>

      <label>Entry Price *</label>
      <input type="number" step="0.0001" min="0" name="entry_price" placeholder="e.g., 105.50" required onchange="calculatePnL()">

      <label>Exit Price *</label>
      <input type="number" step="0.0001" min="0" name="exit_price" placeholder="e.g., 110.00" required onchange="calculatePnL()">

      <label>Entry Timestamp *</label>
      <input type="datetime-local" name="entry_timestamp" required>

      <label>Exit Timestamp *</label>
      <input type="datetime-local" name="exit_timestamp" required>

      <h3>üí∞ Risk Sizing</h3>

      <label>Account Size *</label>
      <input type="number" step="0.01" min="0" name="account_size" placeholder="e.g., 5000.00" required onchange="calculatePnL()">

      <label>Fraction Invested *</label>
      <input type="number" step="0.0001" min="0" max="1" name="fraction_invested" placeholder="e.g., 0.25 (25% of account)" required onchange="calculatePnL()">
      <div class="hint">Enter as decimal: 0.1 = 10%, 0.25 = 25%, etc.</div>

      <div id="pnl-preview" class="pnl-preview" style="display: none;"></div>

      <h3>üß≠ Strategy & Psychology</h3>

      <label>Direction *</label>
      <select name="direction" required>
        <option value="">-- Select --</option>
        <option value="long">Long</option>
        <option value="short">Short</option>
      </select>

      <label>Trade Reason</label>
      <select name="trade_reason">
        <option value="">-- Select --</option>
        <option value="technical_analysis">Technical Analysis</option>
        <option value="fundamental_analysis">Fundamental Analysis</option>
        <option value="news_based">News Based</option>
        <option value="trend_following">Trend Following</option>
        <option value="breakout">Breakout</option>
        <option value="fomo">FOMO</option>
        <option value="chasing">Chasing</option>
        <option value="revenge">Revenge Trading</option>
        <option value="scalping">Scalping</option>
        <option value="swing">Swing Trading</option>
        <option value="other">Other</option>
      </select>

      <label>Notes / Trading Psychology *</label>
      <textarea name="notes" placeholder="Be honest about your emotions and thought process..." required></textarea>
      
      <div class="hint">
        üí° <strong>Examples of useful notes:</strong><br>
        ‚Ä¢ "Saw everyone talking about this on Twitter, had to get in"<br>
        ‚Ä¢ "Was angry about previous loss, wanted to make it back quickly"<br>
        ‚Ä¢ "Breakout looked perfect, felt very confident"<br>
        ‚Ä¢ "Should have entered earlier, jumped in late"
      </div>

      <!-- Modified buttons -->
      <button type="submit" name="action" value="analyze">üìä Save Trade & Analyze My Patterns</button>
      <button type="submit" name="action" value="new_trade">‚ûï Save & Add Another Trade</button>
    </form>
  </div>

<script>
    const MAX_TRADES = 10;

    function addTradeBlock(prefill = null) {
      const blocks = document.querySelectorAll('.trade-block');
      if (blocks.length >= MAX_TRADES) {
        alert(`You can only input up to ${MAX_TRADES} trades.`);
        return;
      }

      const lastBlock = blocks[blocks.length - 1];
      const newBlock = lastBlock.cloneNode(true);

      // Clear inputs unless prefill is given
      const inputs = newBlock.querySelectorAll('input, textarea, select');
      inputs.forEach((input) => {
        if (prefill) {
          const name = input.name.replace("[]", "");
          if (prefill[name] !== undefined) {
            input.value = prefill[name];
          }
        } else {
          input.value = '';
          if (input.tagName === 'SELECT') input.selectedIndex = 0;
        }
      });

      // Add copy button if not present
      if (!newBlock.querySelector('.copy-button')) {
        const copyBtn = document.createElement('button');
        copyBtn.type = 'button';
        copyBtn.className = 'copy-button';
        copyBtn.innerText = 'Copy Previous Trade';
        copyBtn.onclick = () => copyPreviousTrade(newBlock);
        newBlock.appendChild(copyBtn);
      }

      document.getElementById('trade-form').insertBefore(newBlock, document.querySelector('.add-button'));
    }

    function copyPreviousTrade(currentBlock) {
      const blocks = Array.from(document.querySelectorAll('.trade-block'));
      const index = blocks.indexOf(currentBlock);
      if (index <= 0) return alert('No previous trade to copy.');

      const prevInputs = blocks[index - 1].querySelectorAll('input, textarea, select');
      const currInputs = currentBlock.querySelectorAll('input, textarea, select');

      prevInputs.forEach((input, i) => {
        currInputs[i].value = input.value;
      });
    }

    document.getElementById('trade-form').addEventListener('submit', function (e) {
      e.preventDefault();
      document.getElementById('confirmation').style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // --- Drag and Drop for JSON File ---
    const dropzone = document.getElementById('uploadZone');
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.style.backgroundColor = '#e0e0e0';
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.style.backgroundColor = '';
    });

    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.style.backgroundColor = '';
      const file = e.dataTransfer.files[0];
      if (!file || !file.name.endsWith('.json')) {
        alert('Please drop a valid .json file');
        return;
      }

      const reader = new FileReader();
      reader.onload = (event0) => {
        try {
          const trades = JSON.parse(event.target.result);
          trades.forEach((trade, i) => {
            if (i === 0) {
              // Fill the first trade block
              fillBlock(document.querySelector('.trade-block'), trade);
            } else {
              addTradeBlock(trade);
            }
          });
        } catch (err) {
          alert('Invalid JSON file');
        }
      };
      reader.readAsText(file);
    });

    function fillBlock(block, data) {
      const inputs = block.querySelectorAll('input, textarea, select');
      inputs.forEach((input) => {
        const name = input.name.replace("[]", "");
        if (data[name] !== undefined) {
          input.value = data[name];
        }
      });
    }
</script>
</body>
</html>
