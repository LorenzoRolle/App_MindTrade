<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trade Input - MindTrade</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f6f8fa; margin: 0; padding: 20px; }
    .container { max-width: 750px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 0 12px rgba(0,0,0,0.05); }
    h2 { text-align: center; margin-bottom: 25px; }
    h3 { margin-top: 30px; font-size: 18px; border-bottom: 1px solid #ddd; padding-bottom: 5px; color: #333; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
    textarea { resize: vertical; min-height: 80px; }
    button { margin-top: 20px; padding: 12px; width: 100%; background-color: #007bff; color: white; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    .user-info { text-align: right; margin-bottom: 20px; color: #666; }
    .user-info a { color: #007bff; text-decoration: none; }
    .user-info a:hover { text-decoration: underline; }
    .pnl-preview { margin-top: 10px; padding: 8px; border-radius: 5px; font-weight: bold; text-align: center; }
    .profit { background-color: #d4edda; color: #155724; }
    .loss { background-color: #f8d7da; color: #721c24; }
    .hint { font-size: 12px; color: #666; font-style: italic; margin-top: 5px; }
    .upload-zone { border: 2px dashed #888; border-radius: 10px; padding: 20px; text-align: center; color: #aaa; font-size: 16px; transition: border-color 0.3s; cursor: pointer; margin-bottom: 15px; }
    .upload-zone.dragover { border-color: #4cafef; color: #4cafef; }
    .upload-status { margin-top: 10px; padding: 10px; border-radius: 5px; display: none; }
    .success { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }
    @media (max-width: 600px) { .container { padding: 20px; } input, textarea, select { font-size: 16px; } }
    .add-button{background-color: #28a745; color: white;}
    .add-button:hover {background-color: #218838;}
  </style>
</head>
<body>
{% if session.user %}
  <div class="container">
    <div class="user-info">
      <a href="/home">üè† Home</a> |
      Welcome, {{ session.user }}! | <a href="/view_notifications">View Trades</a> | <a href="/results">üß† My Analysis</a> | <a href="/logout">Logout</a>
    </div>
{% endif %}
    <h2>üß† Insert Trade for Analysis</h2>

    <!-- JSON Upload -->
    <div id="uploadZone" class="upload-zone">
      Drag & Drop JSON File Here or Click to Select
    </div>
    <input type="file" id="fileInput" accept=".json" style="display:none;">
    <div id="uploadStatus" class="upload-status"></div>

    <form method="POST" action="/trade_input" id="tradeForm">
      <div class="trade-block">
        <h3>üìä Trade Details</h3>

        <label>Asset Name *</label>
        <input type="text" name="asset_name[]" placeholder="e.g., AAPL, Bitcoin, EUR/USD" required>
        
        <label>Asset Type</label>
        <select name="asset_type[]">
          <option value="">-- Select --</option>
          <option value="stock">Stock</option>
          <option value="etf">ETF</option>
          <option value="crypto">Crypto</option>
          <option value="forex">Forex</option>
        </select>

        <label>Entry Price *</label>
        <input type="number" step="0.0001" min="0" name="entry_price[]" placeholder="e.g., 105.50" required onchange="calculatePnL(this)">

        <label>Exit Price *</label>
        <input type="number" step="0.0001" min="0" name="exit_price[]" placeholder="e.g., 110.00" required onchange="calculatePnL(this)">

        <label>Entry Timestamp *</label>
        <input type="datetime-local" name="entry_timestamp[]" required>

        <label>Exit Timestamp *</label>
        <input type="datetime-local" name="exit_timestamp[]" required>

        <h3>üí∞ Risk Sizing</h3>
        <label>Account Size *</label>
        <input type="number" step="0.01" min="0" name="account_size[]" placeholder="e.g., 5000.00" required onchange="calculatePnL(this)">

        <label>Fraction Invested *</label>
        <input type="number" step="0.0001" min="0" max="1" name="fraction_invested[]" placeholder="e.g., 0.25" required onchange="calculatePnL(this)">
        <div class="hint">Enter as decimal: 0.1 = 10%, 0.25 = 25%, etc.</div>

        <div class="pnl-preview" style="display: none;"></div>

        <h3>üß≠ Strategy & Psychology</h3>
        <label>Direction *</label>
        <select name="direction[]" required onchange="calculatePnL(this)">
          <option value="">-- Select --</option>
          <option value="long">Long</option>
          <option value="short">Short</option>
        </select>

        <label>Trade Reason</label>
        <select name="trade_reason[]">
          <option value="">-- Select --</option>
          <option value="technical_analysis">Technical Analysis</option>
          <option value="fundamental_analysis">Fundamental Analysis</option>
          <option value="news_based">News Based</option>
          <option value="trend_following">Trend Following</option>
          <option value="breakout">Breakout</option>
          <option value="fomo">FOMO</option>
          <option value="chasing">Chasing</option>
          <option value="revenge">Revenge Trading</option>
          <option value="scalping">Scalping</option>
          <option value="swing">Swing Trading</option>
          <option value="other">Other</option>
        </select>

        <label>Notes / Trading Psychology *</label>
        <textarea name="notes[]" placeholder="Be honest about your emotions..." required></textarea>
      </div>

           <!-- üìΩ Bottone sempre in fondo -->
      <div class="form-buttons">
        <button type="button" class="add-button" onclick="addTradeBlock()">‚ûï Add Another Trade</button>
        <button type="submit" name="action" value="analyze">üìä Save & Analyze My Patterns</button>
      </div>
    </form>
  </div>

<script>
  // Clone trade block - FIXED VERSION
  function addTradeBlock(tradeData = null) {
    const blocks = document.querySelectorAll('.trade-block');
    if (blocks.length >= 10) {
      alert("You can only input up to 10 trades.");
      return;
    }

    const lastBlock = blocks[blocks.length - 1];
    const newBlock = lastBlock.cloneNode(true);

    // Pulisci i campi
    const inputs = newBlock.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
      input.value = '';
      if (input.tagName === 'SELECT') input.selectedIndex = 0;
    });

    // Se ci sono dati del trade, riempili
    if (tradeData) {
      fillFormFromTrade(newBlock, tradeData);
    }

    // Inserisci il nuovo blocco PRIMA del div dei bottoni
    const form = document.getElementById('tradeForm');
    const buttons = form.querySelector('.form-buttons');
    form.insertBefore(newBlock, buttons);
  }

  // PnL calc per block
  function calculatePnL(el) {
    const block = el.closest('.trade-block');
    const entry = parseFloat(block.querySelector('[name="entry_price[]"]').value);
    const exit = parseFloat(block.querySelector('[name="exit_price[]"]').value);
    const acc = parseFloat(block.querySelector('[name="account_size[]"]').value);
    const frac = parseFloat(block.querySelector('[name="fraction_invested[]"]').value);
    const dir = block.querySelector('[name="direction[]"]').value;

    if (!entry || !exit || !acc || !frac || !dir) {
      block.querySelector('.pnl-preview').style.display = "none";
      return;
    }

    const invested = acc * frac;
    let pnl = 0;
    if (dir === "long") pnl = (exit - entry) / entry * invested;
    if (dir === "short") pnl = (entry - exit) / entry * invested;

    const pnlBox = block.querySelector('.pnl-preview');
    pnlBox.innerHTML = `P&L: $${pnl.toFixed(2)} (${((pnl/acc)*100).toFixed(2)}%)`;
    pnlBox.className = "pnl-preview " + (pnl >= 0 ? "profit" : "loss");
    pnlBox.style.display = "block";
  }

  // --- JSON Upload (multiple trades supported) - FIXED VERSION ---
  const uploadZone = document.getElementById('uploadZone');
  const fileInput = document.getElementById('fileInput');
  const uploadStatus = document.getElementById('uploadStatus');

  uploadZone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', e => handleFile(e.target.files[0]));
  uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
  uploadZone.addEventListener('dragleave', e => { e.preventDefault(); uploadZone.classList.remove('dragover'); });
  uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });

  function handleFile(file) {
    if (!file.name.endsWith('.json')) return showStatus('Please select valid JSON', 'error');
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = JSON.parse(e.target.result);
        const trades = Array.isArray(data) ? data : [data];
        trades.forEach((t,i) => {
          if (i===0) {
            fillFormFromTrade(document.querySelector('.trade-block'), t);
          } else {
            addTradeBlock(t); // ‚¨ÖÔ∏è Ora passa i dati del trade
          }
        });
        showStatus(`Loaded ${trades.length} trades`, 'success');
      } catch { showStatus('Invalid JSON format','error'); }
    };
    reader.readAsText(file);
  }

  function fillFormFromTrade(block, trade) {
    Object.keys(trade).forEach(k => {
      const el = block.querySelector(`[name="${k}[]"]`);
      if (el) el.value = trade[k];
    });
    calculatePnL(block.querySelector('[name="entry_price[]"]'));
  }

  function showStatus(msg, type) {
    uploadStatus.textContent = msg;
    uploadStatus.className = `upload-status ${type}`;
    uploadStatus.style.display = 'block';
  }
</script>
</body>
</html>