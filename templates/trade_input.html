<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trade Input - MindTrade</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f6f8fa; margin: 0; padding: 20px; }
    .container { max-width: 750px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 0 12px rgba(0,0,0,0.05); }
    h2 { text-align: center; margin-bottom: 25px; }
    h3 { margin-top: 30px; font-size: 18px; border-bottom: 1px solid #ddd; padding-bottom: 5px; color: #333; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
    textarea { resize: vertical; min-height: 80px; }
    button { margin-top: 20px; padding: 12px; width: 100%; background-color: #007bff; color: white; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    .user-info { text-align: right; margin-bottom: 20px; color: #666; }
    .user-info a { color: #007bff; text-decoration: none; }
    .user-info a:hover { text-decoration: underline; }
    .pnl-preview { margin-top: 10px; padding: 8px; border-radius: 5px; font-weight: bold; text-align: center; }
    .profit { background-color: #d4edda; color: #155724; }
    .loss { background-color: #f8d7da; color: #721c24; }
    .hint { font-size: 12px; color: #666; font-style: italic; margin-top: 5px; }
    .upload-zone { border: 2px dashed #888; border-radius: 10px; padding: 20px; text-align: center; color: #aaa; font-size: 16px; transition: border-color 0.3s; cursor: pointer; margin-bottom: 15px; }
    .upload-zone.dragover { border-color: #4cafef; color: #4cafef; }
    .upload-status { margin-top: 10px; padding: 10px; border-radius: 5px; display: none; }
    .success { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }
    @media (max-width: 600px) { .container { padding: 20px; } input, textarea, select { font-size: 16px; } }
  </style>
</head>
<body>
{% if session.user %}
  <div class="container">
    <div class="user-info">
      <a href="/home">üè† Home</a> |
      Welcome, {{ session.user }}! | <a href="/view_notifications">View Trades</a> | <a href="/results">üß† My Analysis</a> | <a href="/logout">Logout</a>
    </div>
{% endif %}
    <h2>üß† Insert Trade for Analysis</h2>

    <!-- JSON Upload -->
    <div id="uploadZone" class="upload-zone">
      Drag & Drop JSON File Here or Click to Select
    </div>
    <input type="file" id="fileInput" accept=".json" style="display:none;">
    <div id="uploadStatus" class="upload-status"></div>

    <form method="POST" action="/trade_input" id="tradeForm">
      <h3>üìä Trade Details</h3>

      <label>Asset Name *</label>
      <input type="text" name="asset_name" id="asset_name" placeholder="e.g., AAPL, Bitcoin, EUR/USD" required>
      
      <label>Asset Type</label>
      <select name="asset_type" id="asset_type">
        <option value="">-- Select --</option>
        <option value="stock">Stock</option>
        <option value="etf">ETF</option>
        <option value="crypto">Crypto</option>
        <option value="forex">Forex</option>
      </select>

      <label>Entry Price *</label>
      <input type="number" step="0.0001" min="0" name="entry_price" id="entry_price" placeholder="e.g., 105.50" required onchange="calculatePnL()">

      <label>Exit Price *</label>
      <input type="number" step="0.0001" min="0" name="exit_price" id="exit_price" placeholder="e.g., 110.00" required onchange="calculatePnL()">

      <label>Entry Timestamp *</label>
      <input type="datetime-local" name="entry_timestamp" id="entry_timestamp" required>

      <label>Exit Timestamp *</label>
      <input type="datetime-local" name="exit_timestamp" id="exit_timestamp" required>

      <h3>üí∞ Risk Sizing</h3>

      <label>Account Size *</label>
      <input type="number" step="0.01" min="0" name="account_size" id="account_size" placeholder="e.g., 5000.00" required onchange="calculatePnL()">

      <label>Fraction Invested *</label>
      <input type="number" step="0.0001" min="0" max="1" name="fraction_invested" id="fraction_invested" placeholder="e.g., 0.25 (25% of account)" required onchange="calculatePnL()">
      <div class="hint">Enter as decimal: 0.1 = 10%, 0.25 = 25%, etc.</div>

      <div id="pnl-preview" class="pnl-preview" style="display: none;"></div>

      <h3>üß≠ Strategy & Psychology</h3>

      <label>Direction *</label>
      <select name="direction" id="direction" required>
        <option value="">-- Select --</option>
        <option value="long">Long</option>
        <option value="short">Short</option>
      </select>

      <label>Trade Reason</label>
      <select name="trade_reason" id="trade_reason">
        <option value="">-- Select --</option>
        <option value="technical_analysis">Technical Analysis</option>
        <option value="fundamental_analysis">Fundamental Analysis</option>
        <option value="news_based">News Based</option>
        <option value="trend_following">Trend Following</option>
        <option value="breakout">Breakout</option>
        <option value="fomo">FOMO</option>
        <option value="chasing">Chasing</option>
        <option value="revenge">Revenge Trading</option>
        <option value="scalping">Scalping</option>
        <option value="swing">Swing Trading</option>
        <option value="other">Other</option>
      </select>

      <label>Notes / Trading Psychology *</label>
      <textarea name="notes" id="notes" placeholder="Be honest about your emotions and thought process..." required></textarea>
      
      <div class="hint">
        üí° <strong>Examples of useful notes:</strong><br>
        ‚Ä¢ "Saw everyone talking about this on Twitter, had to get in"<br>
        ‚Ä¢ "Was angry about previous loss, wanted to make it back quickly"<br>
        ‚Ä¢ "Breakout looked perfect, felt very confident"<br>
        ‚Ä¢ "Should have entered earlier, jumped in late"
      </div>

      <button type="submit" name="action" value="analyze">üìä Save Trade & Analyze My Patterns</button>
      <button type="submit" name="action" value="new_trade">‚ûï Save & Add Another Trade</button>
    </form>
  </div>

<script>
    // PnL calculation function
    function calculatePnL() {
        const entryPrice = parseFloat(document.getElementById('entry_price').value);
        const exitPrice = parseFloat(document.getElementById('exit_price').value);
        const accountSize = parseFloat(document.getElementById('account_size').value);
        const fractionInvested = parseFloat(document.getElementById('fraction_invested').value);
        const direction = document.getElementById('direction').value;
        
        if (!entryPrice || !exitPrice || !accountSize || !fractionInvested || !direction) {
            document.getElementById('pnl-preview').style.display = 'none';
            return;
        }
        
        const investedAmount = accountSize * fractionInvested;
        let pnl;
        
        if (direction === 'long') {
            pnl = (exitPrice - entryPrice) / entryPrice * investedAmount;
        } else if (direction === 'short') {
            pnl = (entryPrice - exitPrice) / entryPrice * investedAmount;
        } else {
            return;
        }
        
        const pnlPercent = (pnl / accountSize) * 100;
        const preview = document.getElementById('pnl-preview');
        
        preview.innerHTML = `P&L: $${pnl.toFixed(2)} (${pnlPercent.toFixed(2)}% of account)`;
        preview.className = 'pnl-preview ' + (pnl >= 0 ? 'profit' : 'loss');
        preview.style.display = 'block';
    }

    // File upload functionality
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const uploadStatus = document.getElementById('uploadStatus');

    // Click to select file
    uploadZone.addEventListener('click', () => {
        fileInput.click();
    });

    // Handle file selection via input
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            handleFile(file);
        }
    });

    // Drag and drop handlers
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        
        const file = e.dataTransfer.files[0];
        if (file) {
            handleFile(file);
        }
    });

    // Handle file processing
    function handleFile(file) {
        if (!file.name.endsWith('.json')) {
            showStatus('Please select a valid JSON file', 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = (event) => {  // Fixed: was event0
            try {
                const data = JSON.parse(event.target.result);
                
                // Check if it's a single trade object or array of trades
                const trades = Array.isArray(data) ? data : [data];
                
                if (trades.length === 0) {
                    showStatus('No trade data found in JSON file', 'error');
                    return;
                }

                // Fill form with first trade (assuming single trade for this form)
                const trade = trades[0];
                fillFormFromTrade(trade);
                
                showStatus(`Successfully loaded trade data: ${trade.asset_name || 'Unknown Asset'}`, 'success');
                
            } catch (err) {
                showStatus('Invalid JSON file format', 'error');
            }
        };
        
        reader.onerror = () => {
            showStatus('Error reading file', 'error');
        };
        
        reader.readAsText(file);
    }

    // Fill form fields from trade data
    function fillFormFromTrade(trade) {
        const fieldMap = {
            'asset_name': trade.asset_name,
            'asset_type': trade.asset_type,
            'entry_price': trade.entry_price,
            'exit_price': trade.exit_price,
            'entry_timestamp': trade.entry_timestamp,
            'exit_timestamp': trade.exit_timestamp,
            'account_size': trade.account_size,
            'fraction_invested': trade.fraction_invested,
            'direction': trade.direction,
            'trade_reason': trade.trade_reason,
            'notes': trade.notes
        };

        Object.keys(fieldMap).forEach(fieldName => {
            const element = document.getElementById(fieldName);
            if (element && fieldMap[fieldName] !== undefined) {
                element.value = fieldMap[fieldName];
            }
        });

        // Trigger PnL calculation after filling
        calculatePnL();
    }

    // Show upload status messages
    function showStatus(message, type) {
        uploadStatus.textContent = message;
        uploadStatus.className = `upload-status ${type}`;
        uploadStatus.style.display = 'block';
        
        // Hide after 3 seconds for success messages
        if (type === 'success') {
            setTimeout(() => {
                uploadStatus.style.display = 'none';
            }, 3000);
        }
    }

    // Update direction change to trigger PnL calculation
    document.getElementById('direction').addEventListener('change', calculatePnL);
</script>
</body>
</html>
